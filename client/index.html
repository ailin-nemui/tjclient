<html>
  <head>
    <title>Test Client</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.11/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.11/themes/smoothness/jquery-ui.css" />
    <style>
      .container {
        overflow: auto;
        height: 550px;
      }
    </style>
    <script type="text/javascript">
    $(function() {
      $('#content').tabs({
        add: sort_tabs,
      })
    })

    function append_message(tab, msg) {
      var t = $('#'+tab)
      $(t).append(msg+'<br/>')
      var d = $('#'+tab)[0]
      if(d) {
        d.scrollTop = d.scrollHeight;        
      }
    }

    function server_log(msg) {
      var now = new Date()
      var time = [now.getHours(), now.getMinutes(), now.getSeconds(), now.getMilliseconds()]
      append_message('server', time.join(':') + ' ==> ' + msg)
    }

    function add_tab(name, index) {
      $('#content').tabs('add', '#'+name, name, parseInt(index))
      $('#'+name).addClass('container')
    }
    
    function sort_tabs() {
    }

    var Handler = function() { }
    
    Handler.prototype.windowlist = function(msg) {
		  $.each(msg.windows, function(widx, win){
		    add_tab(win.window, win.window);
		  })
    }
    
    Handler.prototype.scrollback = function(msg) {
      $('#'+msg.window).html(msg.lines.join('<br/>'))
      $('#'+msg.window).append('<br/>')
      var tab = $('#'+msg.window)[0]
      tab.scrollTop = tab.scrollHeight;
    }
    
    Handler.prototype.addline = function(msg) {
      append_message(msg.window, msg.line);
    }
    
    Handler.prototype.addwindow = function(msg) {
      add_tab(msg.window, msg.window)
    }
    
    Handler.prototype.delwindow = function(msg) {
      $('#content').tabs('remove', parseInt(msg.window))
    }
    
    Handler.prototype.unhandled = function(msg) {
      server_log('UNHANDLED: ' + msg.event);
    }

    $(function() {
      $('#connect').click(function() {
        var servername = $('#servername').eq(0).val()
        var port = $('#port').eq(0).val()
        $('#connect')[0].disabled = true;

        var ws = new WebSocket("ws://"+servername+":"+port)
        var handler = new Handler();

        function trigger_event(ev) {
          ws.send(JSON.stringify(ev))
        }
        
        ws.onopen = function() {
          server_log('Connected')
          
          trigger_event({
            event: 'listwindows',
          })
          
          $('#content').tabs({
            select: function(event, ui) {
              var win = parseInt($(ui.tab).text())
              if(!isNaN(win)) {
                $('#'+win).html('')
                trigger_event({
                  event: 'getscrollback',
                  window: win,
                })  
              }
            },
          })
        }

        ws.onmessage = function(msg) {
          var m = $.parseJSON(msg.data);
          if (handler[m.event]) {
            handler[m.event](m);
          } else {
            handler.unhandled(m);
          }
        }

        ws.onerror = function() {
          server_log(arguments)
        }

        ws.onclose = function() {
          server_log('Closed')
          $('#connect')[0].disabled = false;
        }

        $('#command').keyup(function(e) {
          if(e.keyCode == 13) {
            if(ws.readyState == 1) {
              var idx = $('#content').tabs('option', 'selected')
              var tab = $('#content li')
              tab = tab.get(idx)
              var win = $(tab).text()
              win = parseInt(win)
              if(!isNaN(win)) {
                trigger_event({
                  event: 'sendcommand',
                  window: win,
                  msg: $('#command').eq(0).val(),
                })  
              }
              $('#command').eq(0).val('')            
            }
          }
        })
      })
    });
    </script>
  <head>
  <body>
    Server: <input type="textbox" id="servername" value="localhost" />
    Port: <input type="textbox" id="port" value="3000" />
    <input type="button" value="connect" id="connect" />
    <div id="content">
      <ul>
        <li><a href="#server">Server</a></li>
      </ul>
      <div id="server" class="container"></div>
    </div>
    <br/>
    Command: <input type="textbox" id="command" size="100%" maxlength="510" />
  </body>
</html>