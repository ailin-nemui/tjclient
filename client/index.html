<html>
  <head>
    <title>Test Client</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.11/jquery-ui.min.js"></script>
    <script src="lib/handler.js"></script>
    <script src="lib/view.js"></script>
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.11/themes/smoothness/jquery-ui.css" />
    <style>
      .container {
        overflow: auto;
        height: 550px;
      }
    </style>
    <script type="text/javascript">
    $(function() {
      $('#connect').click(function() {
        var servername = $('#servername').eq(0).val()
        var port = $('#port').eq(0).val()
        $('#connect')[0].disabled = true;
        
        var ws = new WebSocket("ws://"+servername+":"+port)
        var view = new View()
        var handler = new Handler(ws, view);
        
        $('#content').tabs({
          select: function(event, ui) {
            var win = parseInt($(ui.tab).text())
            if(!isNaN(win)) {
              view.clear_window(win)
              handler.getscrollback(win)
              handler.activewindow(win)
            }
          },
          add: view.sort_windows,
          remove: view.sort_windows,
        })
        
        ws.onopen = function() {
          view.log('Connected')
          handler.listwindows()
        }

        ws.onmessage = function(msg) {
          var m = $.parseJSON(msg.data);
          if (handler[m.event]) {
            handler[m.event](m);
          } else {
            handler.unhandled(m);
          }
        }

        ws.onerror = function() {
          view.log(arguments)
        }

        ws.onclose = function() {
          view.log('Closed')
          $('#connect')[0].disabled = false;
        }

        $('#command').keyup(function(e) {
          if(e.keyCode == 13 || e.keyCode == 9) {
            var msg = $('#command').eq(0).val()
            var idx = $('#content').tabs('option', 'selected')
            var tab = $('#content li')
            tab = tab.get(idx)
            var win = $(tab).text()
            win = parseInt(win)
            
            if (e.keyCode == 9) {
            }
            
            if(ws.readyState == 1) {
              if(!isNaN(win)) {
                handler.sendcommand(win, msg)
              }
              
              if (e.keyCode == 13) {
                $('#command').eq(0).val('')                
              }
            }
          }
        })
      })
    });
    </script>
  <head>
  <body>
    Server: <input type="textbox" id="servername" value="localhost" />
    Port: <input type="textbox" id="port" value="3000" />
    <input type="button" value="connect" id="connect" />
    <div id="content">
      <ul>
        <li><a href="#server">Log</a></li>
      </ul>
      <div id="server"></div>
    </div>
    <br/>
    Command: <input type="textbox" id="command" size="100%" maxlength="510" />
  </body>
</html>